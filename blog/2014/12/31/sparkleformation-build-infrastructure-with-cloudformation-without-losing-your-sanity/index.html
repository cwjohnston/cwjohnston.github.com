
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>SparkleFormation: Build infrastructure with CloudFormation without losing your sanity. - rooted - a code blog</title>
  <meta name="author" content="Cameron Johnston">

  
  <meta name="description" content="This article was originally published as part of the 2014 AWS Advent series. Introduction This article assumes some familiarity with CloudFormation &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rootdown.net/blog/2014/12/31/sparkleformation-build-infrastructure-with-cloudformation-without-losing-your-sanity">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-top: 60px;
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    .sharing, .meta {
      margin: 20px 0px 20px 0px;
    }
    .pager {
      margin: 20px 0px 5px 0px;
    }
    .page-footer p {
      text-align: center;
    }
  </style>
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="rooted - a code blog" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30944309-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">

      <a class="brand" href="/">rooted - a code blog</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

      </div>

      <ul class="nav pull-right" data-subscription="rss">
        <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        
      </ul>

        
      <form class="pull-right navbar-search" action="http://google.com/search" method="get">
        <fieldset role="search">
          <input type="hidden" name="q" value="site:rootdown.net" />
          <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
        </fieldset>
      </form>
        
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      
<article class="hentry span9" role="article">

  
  <header class="page-header">
    
      <h1 class="entry-title">SparkleFormation: Build infrastructure with CloudFormation without losing your sanity.</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-31T10:20:00-07:00" pubdate data-updated="true">Dec 31<span>st</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><em>This article was originally published as part of the 2014 <a href="http://awsadvent.tumblr.com/">AWS Advent series</a>.</em></p>

<h2>Introduction</h2>

<p>This article assumes some familiarity with CloudFormation concepts such as stack parameters, resources,
mappings and outputs. See the <a href="http://awsadvent.tumblr.com/post/37391299521/cloudformation-primer">AWS Advent CloudFormation Primer</a> for an introduction.</p>

<p>Although CloudFormation templates are billed as reusable, many users will attest that as these
monolithic JSON documents grow larger, they become <a href="http://www.unixdaemon.net/cloud/the-four-stages-of-cloudformation.html">&#8220;all encompassing JSON file[s] of darkness,&#8221;</a>
and actually reusing code between templates becomes a frustrating copypasta exercise.</p>

<p>From another perspective these JSON documents are actually just hashes, and with a minimal DSL we
can build these hashes programmatically. <a href="https://github.com/sparkleformation/sparkle_formation/">SparkleFormation</a> provides a Ruby DSL for merging
and compiling hashes into CFN templates, and helpers which invoke CloudFormation&#8217;s <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference.html">intrinsic functions</a>
(e.g. Ref, Attr, Join, Map).</p>

<p>SparkleFormation&#8217;s DSL implementation is intentionally loose, imposing little of its own
opinion on how your template should be constructed. Provided you are already familiar with
CloudFormation template concepts and some minimal ammount of Ruby, the rest is merging hashes.</p>

<h2>Templates</h2>

<p>Just as with CloudFormation, the template is the high-level object. In SparkleFormation we instantiate a new template
like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SparkleFormation</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>But an empty template isn&#8217;t going to help us much, so let&#8217;s step into it and at least insert the required
<code>AWSTemplateFormatVersion</code> specification:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SparkleFormation</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">_set</span><span class="p">(</span><span class="s1">&#39;AWSTemplateFormatVersion&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-09-09&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the above case we use the <code>_set</code> helper method because we are setting a top-level key with a string value.
When we are working with hashes we can use a block syntax, as shown here adding a parameter to the top-level
<code>Parameters</code> hash that CloudFormation expects:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SparkleFormation</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">_set</span><span class="p">(</span><span class="s1">&#39;AWSTemplateFormatVersion&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-09-09&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">parameters</span><span class="p">(</span><span class="ss">:food</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>    <span class="n">description</span> <span class="s1">&#39;what do you want to eat?&#39;</span>
</span><span class='line'>    <span class="n">allowed_values</span> <span class="sx">%w( tacos nachos hotdogs )</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Reusability</h2>

<p>SparkleFormation provides primatives to help you build templates out of reusable code, namely:</p>

<ul>
<li>Components</li>
<li>Dynamics</li>
<li>Registries</li>
</ul>


<h3>Components</h3>

<p>Here&#8217;s a component we&#8217;ll name <code>environment</code> which defines our allowed environment parameter values:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SparkleFormation</span><span class="o">.</span><span class="n">build</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">_set</span><span class="p">(</span><span class="s1">&#39;AWSTemplateFormatVersion&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-09-09&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">parameters</span><span class="p">(</span><span class="ss">:environment</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>    <span class="n">default</span> <span class="s1">&#39;test&#39;</span>
</span><span class='line'>    <span class="n">allowed_values</span> <span class="sx">%w( test staging production )</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Resources, parameters and other CloudFormation configuration written into a SparkleFormation component are statically
inserted into any templates using the <code>load</code> method. Now all our stack templates can reuse the same component so
updating the list of environments across our entire infrastructure becomes a snap. Once a template has loaded a
component, it can then step into the configuration provided by the component to make modifications.</p>

<p>In this template example we load the <code>environment</code> component (above) and override the allowed values for the environment
parameter the component provides:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SparkleFormation</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:perpetual_beta</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="ss">:environment</span><span class="p">)</span><span class="o">.</span><span class="n">overrides</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">parameters</span><span class="p">(</span><span class="ss">:environment</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">allowed_values</span> <span class="sx">%w( test staging )</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Dynamics</h3>

<p>Where as components are loaded once at the instantiation of a SparkleFormation template, dynamics are inserted one or
more times throughout a template. They iteratively generate unique resources based on the name and optional
configuration they are passed when inserted.</p>

<p>In this example we insert a <code>launch_config</code> dynamic and pass it a config object containing a run list:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SparkleFormation</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;zookeeper&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="ss">:base</span><span class="p">)</span><span class="o">.</span><span class="n">overrides</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:launch_config</span><span class="p">,</span> <span class="s1">&#39;zookeeper&#39;</span><span class="p">,</span> <span class="ss">:run_list</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;role[zookeeperd]&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>launch_config</code> dynamic (not pictured) can then use intrisic functions like <code>Fn::Join</code> to insert data passed in the config deep inside a launch
configuration, as in this case where we want our template to tell Chef what our run list should be.</p>

<h3>Registries</h3>

<p>Similar to dynamics, a registry entry can be inserted at any point in a SparkleFormation template or dynamic. e.g. a
registry entry can be used to share the same metadata between both AWS::AutoScaling::LaunchConfiguration and
AWS::EC2::Instance resources.</p>

<h2>Translating a ghost of AWS Advent past</h2>

<p>This JSON template from a previous AWS Advent article provisions a single EC2 instance into an
existing VPC subnet and security group:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;AWSTemplateFormatVersion&quot;</span> <span class="o">:</span> <span class="s2">&quot;2010-09-09&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="s2">&quot;Description&quot;</span> <span class="o">:</span> <span class="s2">&quot;make an instance, based on region, ami, subnet, and security group&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="s2">&quot;Parameters&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="s2">&quot;KeyName&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s2">&quot;Description&quot;</span> <span class="o">:</span> <span class="s2">&quot;Name of an existing EC2 KeyPair to enable SSH access to the instance&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;String&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="s2">&quot;VpcId&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s2">&quot;Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;Description&quot;</span> <span class="o">:</span> <span class="s2">&quot;VpcId of your existing Virtual Private Cloud (VPC)&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="s2">&quot;SubnetId&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s2">&quot;Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;Description&quot;</span> <span class="o">:</span> <span class="s2">&quot;SubnetId of an existing subnet in your Virtual Private Cloud (VPC)&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="s2">&quot;AmiId&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s2">&quot;Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;Description&quot;</span> <span class="o">:</span> <span class="s2">&quot;AMI to use&quot;</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="s2">&quot;SecurityGroupId&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s2">&quot;Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;Description&quot;</span> <span class="o">:</span> <span class="s2">&quot;SecurityGroup to use&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="s2">&quot;Resources&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="s2">&quot;Ec2Instance&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s2">&quot;Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;AWS::EC2::Instance&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;Properties&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="s2">&quot;ImageId&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;Ref&quot;</span> <span class="o">:</span> <span class="s2">&quot;AmiId&quot;</span> <span class="p">},</span>
</span><span class='line'>                <span class="s2">&quot;SecurityGroupIds&quot;</span> <span class="o">:</span> <span class="p">[{</span> <span class="s2">&quot;Ref&quot;</span> <span class="o">:</span> <span class="s2">&quot;SecurityGroupId&quot;</span> <span class="p">}],</span>
</span><span class='line'>                <span class="s2">&quot;SubnetId&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;Ref&quot;</span> <span class="o">:</span> <span class="s2">&quot;SubnetId&quot;</span> <span class="p">},</span>
</span><span class='line'>                <span class="s2">&quot;KeyName&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;Ref&quot;</span> <span class="o">:</span> <span class="s2">&quot;KeyName&quot;</span> <span class="p">},</span>
</span><span class='line'>                <span class="s2">&quot;UserData&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;Fn::Base64&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;Fn::Join&quot;</span> <span class="o">:</span>
</span><span class='line'>                  <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>                        <span class="s2">&quot;#!/bin/bash -v\n&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="s2">&quot;curl http://aprivatebucket.s3.amazonaws.com/bootstrap.sh -o /tmp/bootstrap.sh\n&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="s2">&quot;bash /tmp/bootstrap.sh\n&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="s2">&quot;# If all went well, signal success\n&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="s2">&quot;cfn-signal -e $? -r &#39;Chef Server configuration&#39;\n&quot;</span>
</span><span class='line'>                    <span class="p">]]}}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="s2">&quot;Outputs&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s2">&quot;InstanceId&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s2">&quot;Value&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;Ref&quot;</span> <span class="o">:</span> <span class="s2">&quot;Ec2Instance&quot;</span> <span class="p">},</span>
</span><span class='line'>            <span class="s2">&quot;Description&quot;</span> <span class="o">:</span> <span class="s2">&quot;Instance Id of newly created instance&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="s2">&quot;Subnet&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s2">&quot;Value&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;Ref&quot;</span> <span class="o">:</span> <span class="s2">&quot;SubnetId&quot;</span> <span class="p">},</span>
</span><span class='line'>            <span class="s2">&quot;Description&quot;</span> <span class="o">:</span> <span class="s2">&quot;Subnet of instance&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="s2">&quot;SecurityGroupId&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s2">&quot;Value&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;Ref&quot;</span> <span class="o">:</span> <span class="s2">&quot;SecurityGroupId&quot;</span> <span class="p">},</span>
</span><span class='line'>            <span class="s2">&quot;Description&quot;</span> <span class="o">:</span> <span class="s2">&quot;Security Group of instance&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not terrible, but the JSON is a little hard on the eyes. Here&#8217;s the same thing in Ruby,
using SparkleFormation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SparkleFormation</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:vpc_instance</span><span class="p">)</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">set!</span><span class="p">(</span><span class="s1">&#39;AWSTemplateFormatVersion&#39;</span> <span class="s1">&#39;2010-09-09&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">description</span> <span class="s1">&#39;make an instance, based on region, ami, subnet, and security group&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">parameters</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">key_name</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;Name of an existing EC2 KeyPair to enable SSH access to the instance&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">vpc_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;VpcId of your existing Virtual Private Cloud (VPC)&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">subnet_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;SubnetId of an existing subnet in your Virtual Private Cloud (VPC)&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">ami_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;AMI to use&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">security_group_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;SecurityGroup to use&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">resources</span><span class="p">(</span><span class="ss">:ec2_instance</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">type</span> <span class="s1">&#39;AWS::EC2::Instance&#39;</span>
</span><span class='line'>    <span class="n">properties</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">image_id</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:ami_id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">security_group_ids</span> <span class="o">[</span><span class="n">ref!</span><span class="p">(</span><span class="ss">:security_group_id</span><span class="p">)</span><span class="o">]</span>
</span><span class='line'>      <span class="n">subnet_id</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:subnet_id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">key_name</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:key_name</span><span class="p">)</span>
</span><span class='line'>      <span class="n">user_data</span> <span class="n">base64!</span><span class="p">(</span>
</span><span class='line'>        <span class="n">join!</span><span class="p">(</span>
</span><span class='line'>          <span class="s2">&quot;#!/bin/bash -v</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;curl http://aprivatebucket.s3.amazonaws.com/bootstrap.sh -o /tmp/bootstrap.sh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;bash /tmp/bootstrap.sh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;# If all went well, signal success</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;cfn-signal -e $? -r &#39;Chef Server configuration&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">outputs</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">instance_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;Instance Id of newly created instance&#39;</span>
</span><span class='line'>      <span class="n">value</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:instance_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">subnet</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;Subnet of instance&#39;</span>
</span><span class='line'>      <span class="n">value</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:subnet_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">security_group_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;Security group of instance&#39;</span>
</span><span class='line'>      <span class="n">value</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:security_group_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Without taking advantage of any of SparkleFormation&#8217;s special capabilities, this translation is
already a few lines shorter and easier to read as well. That&#8217;s a good start, but we can do better.</p>

<p>The template format version specification and parameters required for this template are common to any
stack where EC2 compute resources may be used, whether they be single EC2 instances or
Auto Scaling Groups, so lets take advantage of some SparkleFormation features to make them reusable.</p>

<p>Here we have a <code>base</code> component that inserts the common parameters into templates which load it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SparkleFormation</span><span class="o">.</span><span class="n">build</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">set!</span><span class="p">(</span><span class="s1">&#39;AWSTemplateFormatVersion&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-09-09&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">parameters</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">key_name</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;Name of and existing EC2 KeyPair to enable SSH access to the instance&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">vpc_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;VpcId of your existing Virtual Private Cloud (VPC)&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">subnet_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;SubnetId of an existing subnet in your Virtual Private Cloud (VPC)&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">ami_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;AMI You want to use&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">security_group_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;SecurityGroup to use&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">outputs</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">subnet</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;Subnet of instance&#39;</span>
</span><span class='line'>      <span class="n">value</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:subnet_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">security_group_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;Security group of instance&#39;</span>
</span><span class='line'>      <span class="n">value</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:security_group_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that the template version and common parameters have moved into the new <code>base</code> component, we can
make use of them by loading that component as we instantiate our new template, specifying that the
template will override any pieces of the component where the two intersect.</p>

<p>Let&#8217;s update the SparkleFormation template to make use of the new <code>base</code> component:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SparkleFormation</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:vpc_instance</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="ss">:base</span><span class="p">)</span><span class="o">.</span><span class="n">overrides</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">description</span> <span class="s1">&#39;make an instance, based on region, ami, subnet, and security group&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">resources</span><span class="p">(</span><span class="ss">:ec2_instance</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">type</span> <span class="s1">&#39;AWS::EC2::Instance&#39;</span>
</span><span class='line'>    <span class="n">properties</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">image_id</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:ami_id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">security_group_ids</span> <span class="o">[</span><span class="n">ref!</span><span class="p">(</span><span class="ss">:security_group_id</span><span class="p">)</span><span class="o">]</span>
</span><span class='line'>      <span class="n">subnet_id</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:subnet_id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">key_name</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:key_name</span><span class="p">)</span>
</span><span class='line'>      <span class="n">user_data</span> <span class="n">base64!</span><span class="p">(</span>
</span><span class='line'>        <span class="n">join!</span><span class="p">(</span>
</span><span class='line'>          <span class="s2">&quot;#!/bin/bash -v</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;curl http://aprivatebucket.s3.amazonaws.com/bootstrap.sh -o /tmp/bootstrap.sh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;bash /tmp/bootstrap.sh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;# If all went well, signal success</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;cfn-signal -e $? -r &#39;Chef Server configuration&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">outputs</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">instance_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;Instance Id of newly created instance&#39;</span>
</span><span class='line'>      <span class="n">value</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:instance_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because the <code>base</code>component includes the parameters we need, the template no longer explicitly
describes them.</p>

<h2>Advanced tips and tricks</h2>

<p>Since SparkleFormation is Ruby, we can get a little fancy. Let&#8217;s say we want to build 3 subnets into an existing VPC. If we know the VPC&#8217;s /16 subnet we can provide it as an environment variable (<code>export VPC_SUBNET="10.1.0.0/16"</code>), and then call that variable in a template that generates additional subnets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SparkleFormation</span><span class="o">.</span><span class="n">build</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">set!</span><span class="p">(</span><span class="s1">&#39;AWSTemplateFormatVersion&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-09-09&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">octets</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VPC_SUBNET].split(&#39;</span><span class="o">.</span><span class="s1">&#39;).slice(0,2).join(&#39;</span><span class="o">.</span><span class="s1">&#39;)</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  subnets = %w(1 2 3)</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  parameters(:vpc_id) do</span>
</span><span class='line'><span class="s1">    type &#39;</span><span class="nb">String</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">    description &#39;</span><span class="no">Existing</span> <span class="no">VPC</span> <span class="no">ID</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  end</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  parameters(:route_table_id) do</span>
</span><span class='line'><span class="s1">    type &#39;</span><span class="nb">String</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">    description &#39;</span><span class="no">Existing</span> <span class="no">VPC</span> <span class="no">Route</span> <span class="no">Table</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  end</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  subnets.each do |subnet|</span>
</span><span class='line'><span class="s1">    resources(&quot;vpc_subnet_#{subnet}&quot;.to_sym) do</span>
</span><span class='line'><span class="s1">    type &#39;</span><span class="no">AWS</span><span class="o">::</span><span class="no">EC2</span><span class="o">::</span><span class="no">Subnet</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">    properties do</span>
</span><span class='line'><span class="s1">      vpc_id ref!(:vpc_id)</span>
</span><span class='line'><span class="s1">      cidr_block octets + &#39;</span><span class="o">.</span><span class="s1">&#39; + subnet + &#39;</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">      availability_zone &#39;</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="n">a</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">    end</span>
</span><span class='line'><span class="s1">  end</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  resources(&quot;vpc_subnet_route_table_association_#{subnet}&quot;.to_sym) do</span>
</span><span class='line'><span class="s1">    type &#39;</span><span class="no">AWS</span><span class="o">::</span><span class="no">EC2</span><span class="o">::</span><span class="no">SubnetRouteTableAssociation</span><span class="err">&#39;</span>
</span><span class='line'>    <span class="n">properties</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">route_table_id</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:route_table_id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">subnet_id</span> <span class="n">ref!</span><span class="p">(</span><span class="s2">&quot;vpc_subnet_</span><span class="si">#{</span><span class="n">subnet</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">to_sym</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course we could place the subnet and route table association resources into a dynamic, so that we could just call the dynamic with some config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">subnets</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">subnet</span><span class="o">|</span>
</span><span class='line'>  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:vpc_subnet</span><span class="p">,</span> <span class="n">subnet</span><span class="p">,</span> <span class="n">subnet_cidr</span> <span class="o">=&gt;</span> <span class="n">octets</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">subnet</span> <span class="o">+</span> <span class="s1">&#39;.0/24&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Okay, this all sounds great! But how do I <em>operate</em> it?</h2>

<p>SparkleFormation by itself does not implement any means of sending its output to the CloudFormation
API. In this simple case, a SparkleFormation template named <code>ec2_example.rb</code> is output to JSON
which you can use with CloudFormation as usual:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;sparkle_formation&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="no">JSON</span><span class="o">.</span><span class="n">pretty_generate</span><span class="p">(</span>
</span><span class='line'>  <span class="no">SparkleFormation</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;ec2_example.rb&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <a href="https://github.com/hw-labs/knife-cloudformation">knife-cloudformation</a> plugin for Chef&#8217;s <code>knife</code> command adds sub-commands for creating, updating,
inspecting and destroying CloudFormation stacks described by SparkleFormation code or plain JSON
templates. Using knife-cloudformation does not require Chef to be part of your toolchain, it simply
leverages knife as an execution platform.</p>

<p>Advent readers may recall a previous article on <a href="http://awsadvent.tumblr.com/post/38685647817/strategies-reusable-cfn-templates">strategies for reusable CloudFormation templates</a>
which advocates a &#8220;layer cake&#8221; approach to deploying infrastructure using CloudFormation stacks:</p>

<blockquote><p>The overall approach is that your templates should have sufficient parameters and outputs to be
re-usable across environments like dev, stage, qa, or prod and that each layer’s template builds on
the next.</p></blockquote>

<p>Of course this is all well and good, until we find ourselves, once again, copying and pasting.
This time its stack outputs instead of JSON, but again, we can do better.</p>

<p>The recent 0.2.0 release of knife-cloudformation adds a new <code>--apply-stack</code> parameter
which makes operating &#8220;layer cake&#8221; infrastructure much easier.</p>

<p>When passed one or more instances of <code>--apply-stack STACKNAME</code>, knife-cloudformation will cache the outputs of the named stack
and use the values of those outputs as the default values for parameters of the same name in the stack you are creating.</p>

<p>For example, a stack &#8220;coolapp-elb&#8221; which provisions an ELB and an associated security group has been configured with the following outputs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='shell'><span class='line'><span class="nv">$ </span>knife cloudformation describe coolapp-elb
</span><span class='line'>Resources <span class="k">for </span>stack: coolapp-elb
</span><span class='line'>Updated                  Logical Id                Type                                     Status
</span><span class='line'>Status Reason
</span><span class='line'>2014-11-17 22:54:28 UTC  CoolappElb               AWS::ElasticLoadBalancing::LoadBalancer
</span><span class='line'>CREATE_COMPLETE
</span><span class='line'>2014-11-17 22:54:47 UTC  CoolappElbSecurityGroup  AWS::EC2::SecurityGroup
</span><span class='line'>CREATE_COMPLETE
</span><span class='line'>
</span><span class='line'>Outputs <span class="k">for </span>stack: coolapp-elb
</span><span class='line'>Elb Dns: coolapp-elb-25352800.us-east-1.elb.amazonaws.com
</span><span class='line'>Elb Name: coolapp-elb
</span><span class='line'>Elb Security Group: coolapp-elb-CoolappElbSecurityGroup-JSR4RUT66Z66
</span></code></pre></td></tr></table></div></figure>


<p>The values from the ElbName and ElbSecurityGroup would be of use to us in attaching an app server
auto scaling group to this ELB, and we could use those values automatically by setting parameter
names in the app server template which match the ELB stack&#8217;s output names:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SparkleFormation</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:coolapp_asg</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">parameters</span><span class="p">(</span><span class="ss">:elb_name</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="n">parameters</span><span class="p">(</span><span class="ss">:elb_security_group</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">type</span> <span class="s1">&#39;String&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once our <code>coolapp_asg</code> template uses parameter names that match the output names from the <code>coolapp-elb</code> stack, we can deploy the app server layer &#8220;on top&#8221; of the ELB layer using <code>--apply-stack</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>knife cloudformation create coolapp-asg --apply-stack coolapp-elb
</span></code></pre></td></tr></table></div></figure>


<p>Similarly, if we use a SparkleFormation template to build our VPC, we can set a number of VPC outputs that will be useful when building stacks inside the VPC:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">outputs</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">vpc_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;VPC ID&#39;</span>
</span><span class='line'>      <span class="n">value</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:vpc_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">subnet_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;VPC Subnet ID&#39;</span>
</span><span class='line'>      <span class="n">value</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:subnet_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">route_table_id</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">description</span> <span class="s1">&#39;VPC Route Table&#39;</span>
</span><span class='line'>      <span class="n">value</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:route_table</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This &#8216;apply stack&#8217; approach is just the latest way in which the SparkleFormation tool chain can help you keep your sanity when building infrastructure with CloudFormation.</p>

<h2>Further reading</h2>

<p>I hope this brief tour of SparkleFormation&#8217;s capabilities has piqued your interest. For some AWS users, the combination of
SparkleFormation and knife-cloudformation helps to address a real pain point in the infrastructure-as-code tool chain,
easing the development and operation of layered infrastructure.</p>

<p>Here&#8217;s some additional material to help you get started:</p>

<ul>
<li><a href="https://github.com/sparkleformation/sparkle_formation/tree/master/docs">SparkleFormation documentation</a> - more detailed discussion of the concepts introduced here, and mmore!</li>
<li><a href="https://github.com/hw-labs/sparkleformation-starter-kit">SparkleFormation starter kit</a> - an example repository containing some basic templates for deploying a VPC and an EC2 instance inside that VPC.</li>
<li><a href="https://www.youtube.com/watch?v=JnNWn3BoAcM&amp;t=2h40m50s">Sean Porter&#8217;s SparkleFormation ignite talk from DevOpsDays Vancouver 2014</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Cameron Johnston</span></span>

      








  


<time datetime="2014-12-31T10:20:00-07:00" pubdate data-updated="true">Dec 31<span>st</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/aws/'>aws</a>, <a class='category' href='/blog/categories/cloudformation/'>cloudformation</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://rootdown.net/blog/2014/12/31/sparkleformation-build-infrastructure-with-cloudformation-without-losing-your-sanity/" data-via="cwjohnston" data-counturl="http://rootdown.net/blog/2014/12/31/sparkleformation-build-infrastructure-with-cloudformation-without-losing-your-sanity/" >Tweet</a>
  
  
  
</div>

    
    
    <section>
      <h1>Comments</h1>
      <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </section>
    
    <ul class="pager">
      
      <li class="previous"><a class="basic-alignment left"
        href="/blog/2013/09/25/silencing-sensu-with-a-chef-handler/" title="Previous Post:
        Silencing Sensu with a Chef Handler">&laquo; Silencing Sensu with a Chef Handler</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
    </ul>
  </footer>
</article>

<aside class="sidebar-nav span3">
  
    <section>
<p>Hi, I'm Cameron and these are some of my opinions.</p>
<p><a href="/about">More...</a></p>
</section>
<section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/blog/2014/12/31/sparkleformation-build-infrastructure-with-cloudformation-without-losing-your-sanity/">SparkleFormation: Build infrastructure with CloudFormation without losing your sanity.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/25/silencing-sensu-with-a-chef-handler/">Silencing Sensu with a Chef Handler</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/04/hipchat-lwrp-for-chef/">HipChat LWRP for Chef</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/14/adding-resource-tag-lwrp-to-the-aws-cookbook/">Adding resource_tag LWRP to the aws cookbook</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/12/campfire-sing-a-longs-with-chef/">Campfire sing-a-longs with Chef</a>
      </li>
    
  </ul>
</section>

<section class="well">
  <ul id="gh_repos" class="nav">
    <li class="nav-header">GitHub Repos</li>
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/cwjohnston">@cwjohnston</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'cwjohnston',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="well">
  <ul id="tweets" class="nav">
    <li class="nav-header">Latest Tweets</li>
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("cwjohnston", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/cwjohnston" class="twitter-follow-button" data-show-count="false">Follow @cwjohnston</a>
  
</section>


<section class="well">
  <h1>My Pinboard</h1>
  <ul id="pinboard_linkroll" class="nav">Fetching linkroll...</ul>
  <p><a href="http://pinboard.in/u:cwjohnston">My Pinboard Bookmarks &raquo;</a></p>
</section>
<script type="text/javascript">
  var linkroll = 'pinboard_linkroll'; //id target for pinboard list
  var pinboard_user = "cwjohnston"; //id target for pinboard list
  var pinboard_count = 3; //id target for pinboard list
  (function(){
    var pinboardInit = document.createElement('script');
    pinboardInit.type = 'text/javascript';
    pinboardInit.async = true;
    pinboardInit.src = '/javascripts/pinboard.js';
    document.getElementsByTagName('head')[0].appendChild(pinboardInit);
  })();
</script>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2014 - Cameron Johnston -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'rootdowndotnet';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://rootdown.net/blog/2014/12/31/sparkleformation-build-infrastructure-with-cloudformation-without-losing-your-sanity/';
        var disqus_url = 'http://rootdown.net/blog/2014/12/31/sparkleformation-build-infrastructure-with-cloudformation-without-losing-your-sanity/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
